name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  setup-and-test:
    name: Setup Environment & Test Godot Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node.js for Claude CLI
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install Claude CLI globally
      - name: Install Claude CLI
        run: |
          npm install -g @anthropic-ai/claude-code
          echo "Claude CLI installed successfully"

      # Verify Claude CLI installation
      - name: Verify Claude CLI
        run: |
          claude --version || echo "Claude CLI installed (version check may require auth)"

      # Setup Godot Engine
      - name: Setup Godot Engine
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.3.0
          use-dotnet: false
          include-templates: false

      # Verify Godot installation
      - name: Verify Godot
        run: |
          godot --version
          echo "Godot Engine installed successfully"

      # Install skills to .claude/skills directory
      - name: Install Claude Skills
        run: |
          mkdir -p .claude/skills
          cp -r skills/* .claude/skills/
          echo "Skills installed:"
          find .claude/skills -name "SKILL.md" -type f

      # Validate skill format
      - name: Validate Skills
        run: |
          echo "Validating skill files..."
          for skill_file in .claude/skills/*/SKILL.md; do
            if [ -f "$skill_file" ]; then
              # Check for YAML frontmatter
              if head -1 "$skill_file" | grep -q "^---$"; then
                # Check for required fields
                if grep -q "^name:" "$skill_file" && grep -q "^description:" "$skill_file"; then
                  echo "✓ Valid: $skill_file"
                else
                  echo "✗ Missing required fields in: $skill_file"
                  exit 1
                fi
              else
                echo "✗ Missing YAML frontmatter in: $skill_file"
                exit 1
              fi
            fi
          done
          echo "All skills validated successfully!"

      # Import Godot project (generates .godot cache)
      - name: Import Godot Project
        run: |
          echo "=== Importing Godot Project ==="
          cd example-project
          godot --headless --import . 2>&1 | tee import.log || true
          echo ""
          echo "Import complete. Checking for errors..."
          if grep -i "error" import.log; then
            echo "Errors found during import!"
            exit 1
          fi
          echo "No import errors found."

      # Validate GDScript files
      - name: Validate GDScript
        run: |
          echo "=== Validating GDScript Files ==="
          cd example-project
          for script in $(find . -name "*.gd" -type f); do
            echo "Checking: $script"
            # Run script through Godot's parser
            godot --headless --script "$script" --check-only 2>&1 || true
          done
          echo "Script validation complete."

      # Run project in headless mode
      - name: Run Headless Test
        run: |
          echo "=== Running Headless Test ==="
          cd example-project
          timeout 30 godot --headless --quit 2>&1 | tee run.log || true
          echo ""
          echo "=== Game Output ==="
          cat run.log
          echo ""
          echo "=== Checking for Expected Output ==="
          if grep -q "\[TicTacToe\] Game initialized" run.log; then
            echo "✓ Game initialized successfully"
          else
            echo "✗ Game initialization message not found"
            exit 1
          fi
          if grep -q "\[TicTacToe\] Board initialized" run.log; then
            echo "✓ Board initialized successfully"
          else
            echo "✗ Board initialization message not found"
            exit 1
          fi
          echo ""
          echo "=== Checking for Errors ==="
          if grep -iE "(SCRIPT ERROR|ERROR:)" run.log; then
            echo "Errors detected in game output!"
            exit 1
          fi
          echo "No errors found in game output."

      # Display environment summary
      - name: Test Summary
        run: |
          echo "========================================="
          echo "        CI TEST SUMMARY"
          echo "========================================="
          echo ""
          echo "Environment:"
          echo "  Node.js: $(node --version)"
          echo "  npm: $(npm --version)"
          echo "  Godot: $(godot --version)"
          echo ""
          echo "Skills Installed:"
          ls -1 .claude/skills/
          echo ""
          echo "Project Structure:"
          find example-project -type f -name "*.gd" -o -name "*.tscn" -o -name "project.godot" | head -20
          echo ""
          echo "========================================="
          echo "        ALL TESTS PASSED"
          echo "========================================="
